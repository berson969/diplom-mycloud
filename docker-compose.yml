services:
    postgres:
        container_name: "${DB_HOST}"
        image: postgres:16-alpine
        ports:
            - "${DB_PORT}:5432"
        restart: unless-stopped
        environment:
            POSTGRES_USER: "${DB_USER}"
            POSTGRES_PASSWORD: "${DB_PASS}"
            POSTGRES_DB: "${DB_BASE}"
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_BASE}" ]
            interval: 10s
            timeout: 15s
            retries: 5
        volumes:
            - postgres_data:/var/lib/postgresql/data/

    backend:
        container_name: backend
        build:
            context: ./backend
        volumes:
            - ./backend:/app
            - static_volume:/app/static
            - storage:/storage
        expose:
            - 8000
        depends_on:
            - postgres

    nginx:
        container_name: nginx-proxy
        image: nginx:latest
        restart: always
        ports:
            - '80:80'
        volumes:
            - static_volume:/usr/share/nginx/html/static
            - storage:/storage
            - ./nginx:/etc/nginx
        depends_on:
            - postgres
            - backend

volumes:
    postgres_data:
    static_volume:
    storage:
