# Дипломный проект по профессии «Fullstack-разработчик на Python»

[![Server Backend Django application MyCloud](https://github.com/berson969/diplom-mycloud/actions/workflows/backend.yaml/badge.svg)](https://github.com/berson969/diplom-mycloud/actions/workflows/backend.yaml)

[![Deploy React Frontend](https://github.com/berson969/diplom-mycloud/actions/workflows/frontend.yaml/badge.svg)](https://github.com/berson969/diplom-mycloud/actions/workflows/frontend.yaml)

## Облачное хранилище My Cloud
**ЗАПУСКАЕТСЯ ЛОКАЛЬНО**

Клонируем репозиторий. Создаем .env согласно приведенного ниже  шаблона.
Запускаем `docker-compose up -d` для локальной установки сервера.
Возможен доступ в админку по адресу [https://localhost/admin/](https://localhost/admin/)

Запускаем клиентскую часть с помощью команд
```
cd frontend/
npm install
npm run build
npm run preview
```
После загрузки по адресу  [http://localhost:4173/](http://localhost:4173/) будет доступна клиентская часть приложения

Суперпользователь для проверки `admin` с паролем `adminNEWadmin`, его же можно использовать для админки джанго.

Пользователи без административных прав заводятся в самом приложении.



**ПОКА НЕ РАБОТАЕТ**
И клиентская и серверная часть смонтированы, но из-за CORS ограничений  'django.middleware.csrf.CsrfViewMiddleware' не позволяет передавать csrf токены
Клиентская часть расположена по адресу     [https://berson969.github.io/diplom-mycloud/](https://berson969.github.io/diplom-mycloud/)

Серверная часть размещена на сервере с ip   [185.10.45.10](https://185.10.45.10)


Используется самоподписанный сертификат Openssl, для работы с ним его надо внести с связку ключей для проверенных сертификатов
сам сертификат лежит в `/nginx/ssl/cert.crt` или `/nginx/ssl/mysite.crt`. Пока я поочередно их тестирую, во втором прописан и localhost

Суперпользователь для проверки `admin` с паролем `adminNEWadmin`, его же можно использовать для админки Джанго

Пользователи без административных прав заводятся в самом приложении


```
Добрый день, Василий) Я что-то наковырял, но мне хотелось бы, чтобы проверили не работоспособность приложения,
а саму структуру, т к самому без использования опыта экспертов сложно понять, в каком направлении я двигаюсь.
Клиентская часть расположена по адресу    [https://berson969.github.io/diplom-mycloud/](https://berson969.github.io/diplom-mycloud/)
Серверная часть размещена на сервере с ip   [185.10.45.10](https://185.10.45.10)
Суперпользователь для проверки `admin` с паролем `adminNEWadmin`, его же можно использовать для админки джанго.
Создается автоматически при создании приложения Джанго.
Пользователи без административных прав заводятся в самом приложении.
Пока они не работают как должны, но если установить локально, то в этом случае функционал работает. Возможно есть
недочеты по функционалу, я, что вижу, подправляю, но, как и говорил выше, интересно получить ответ или предложения
 по самой структуре.
Описание находится в README.md. Там же подробно как локально запустить сервер-приложение.
В разделе "проблемы проекта" я оставил вопросы, которые не смог решить, хотя потратил времени больше,
чем на весь непосредственно проект.  Вроде бы это не влияет на саму работу, но хотелось бы получить ответ как это решать.
Просьба посмотреть на мой репо, т к с момента выставления на проверку и самой проверке проходит 3 недели,
то ситуация может поменяться. Я постараюсь писать в README.md.
Спасибо за время уделенное моей работе)
```


### Структура проекта
В папке `backend` лежат исходники для серверной части. Она собрана на базе приложения Джанго и базы данных `PostgreSQL`

В папке `frontend` лежат исходники клиентской части. Она сделана в приложении Vite на базе React+Redux. Для написания запросов к API использован RTK Query.
Стейты хранятся в слайсе. В самом стейте находятся currentUser, а также состояние приложения

Авторизация осуществляется с помощью стандартного пользователя Джанго, с помощью стандартной сессии. На стороне клиента данные хранятся в store и также в sessionStorage

### Реализация проекта
На данный момент реализовано:
 - функционал серверной части (фактически все работает, только в процессе требуется определенная доработка )
 - проверка работоспособности осуществляется с помощью uni-тестов
 - клиентская часть реализован весь необходимый функционал, кроме
            - редактирование файлов (реализовано)
            - использование просмотра хранилища от имени администратора (реализовано)
            - редактирование пользователей (реализовано)
            - при удалении файла, удаляется запись в БД но не удаляется сам файл из хранилища (реализовано)
- для деплоя пока только сама база postgreSQL используется docker-compose, все остальное только локально

На 14/6/24 реализована вся логика , которую хотел реализовать.
Остается вопрос с деплоем
на 4/07/24 задеплоил, но не могу обойти разрешения CORS
работает локально, не работает с github


### Запуск проекта

**ИЗМЕНЕНО** На данный момент реализован деплой на сервер и клиентcкая часть расположена на github

***УСТАРЕЛО*** На данный момент реализованна только возможность локального запуска


**НЕОБХОДИМО ДЛЯ ЛОКАЛЬНОГО ЗАПУСКА**
1. Создать файл `.env` и установить необходимые переменные. Он должен находится в корневой папке

```
DB_BASE=
DB_HOST=postgresdb
DB_PORT=5432
DB_USER=
DB_PASS=
DJANGO_SETTINGS_MODULE=mycloud.settings
SECRET_KEY=django-insecure-z6$$*7$9*r_d%xgek=y=u3f80@fj1mbq=y3*mj6k-ik_0#*v!w
DEBUG=True
ALLOWED_HOSTS="localhost, 185.10.45.10, postgresdb, nginx, backend, 0.0.0.0, [::1]"
FRONTEND_URL=http://localhost:4173
SERVER_NAME=localhost
```

***УСТАРЕЛО*** Теперь можно использовать `docker-compose.yml` , который запустит приложение на localhost через прокси по 80 порту.
Если есть необходимость в заведении пользователя с правами администратора тогда
```$ docker-compose exec backend-server python manage.py createsuperuser```


***УСТАРЕЛО*** так тоже работает, но уже есть более простой способ
Для локального запуска бекенда нужно.
Предполагается разворачивание на локальном хосте и наличие python3.10 и NodeJS

2. Запустить контейнер с базой данных

```
docker-compose -f docker-compose-DB.yml up --build
```

3. Устанавливаем и запускаем само приложение

```
# переходим в папку бекенда
cd backend/

# создание и активация виртуального окружения
python3 -m venv venv
source venv/bin/activate

# устанавливаем зависимости
pip install -r requirements.txt

# делаем миграции
python manage.py migrate

# запускаем тесты
python manage.py test

# создаем административного пользователя
python manage.py createsuperuser

# запускаем приложение
python manage.py runserver localhost:8000
```





Для локального запуска фроненд приложения необходимо

1. перейти в папку `frontend`
`cd frontend/`
2. установить зависимости
`npm i`
3. запустить приложение в режиме разработки
`npm run dev`


***УСТАРЕЛО***
структура файл `.env` для фронтенда
```
VITE_BASE_URL=
VITE_SECRET_KEY=super-secret-key
```

### Проблемы проекта

- не понимаю как подключить статику для админки Django, все файлы получаются с помощью отдельного запроса, но в саму админку не подтягиваются, при этом почему-то storage/, сделанный точно так же нормально функционирует
- если для серверной части я использую самоподписанный Openssl, это достаточный уровень безопасности? Не понимаю почему, но бесплатных сертификатов без доменных имен нет, а платные сильно дороже, чем для доменов.
- непонятно, достаточно ли настроек для обхода ограничений CORS : хотя удается реализовать прохождение запросов, но делаю это методом тыка, поэтому не понимаю насколько настройки необходимы и достаточны На данный момент как раз эти ограничения не позволяют использовать удаленный сервер


  **ЧТО НИЖЕ УЖЕ РЕШЕНО**
- есть варнинги связанные со старой необновляемой библиотекой `"react-contexify": "^6.0.0"`, для использования кастомного контекстного меню (возможно переделаю на bootstrap) переделал на `rc-menu` оказалось тоже самое, есть вариннг связанный с устаревшим методом **все убрал**
- сделал docker-compose.yml, который включает джанго серавера, но пока не работает. **все теперь работает**
- после неправильного логина не происходит подтягивания ( loginUser or currentUser) и хук  useGetFilesQuery(currentUser.user_folder) отрабатывает с ошибкой **решено** , просто опечатался  в [Login.tsx](frontend%2Fsrc%2Fcomponents%2FLogin.tsx) )
- [FileContextMenu.tsx](frontend%2Fsrc%2Fcomponents%2FFileContextMenu.tsx) при нескольких подряд действий для удаления зависает и не дает удалять следующие, решил с помощью принудительного **refectg()** так делать можно?
- при обновлении паролей [UpdateUser.tsx](frontend%2Fsrc%2Fcomponents%2FUpdateUser.tsx) новый пароль не соответствует введенному - **исправлено**
- есть ишью о том, что какой-то элемент формы не имеет id, пока этот элемент не нашел [AdminPanel.tsx](frontend%2Fsrc%2Fcomponents%2FAdminPanel.tsx)?? **вроде убрал**
